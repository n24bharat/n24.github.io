<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>N24.in — Independent India News Monitor</title>
  <meta name="description" content="N24 - Aggregates independent Hindi news & video journalism. Default: last 24 hours."/>
  <style>
    /* Minimal, focused styles for fast paint */
    :root{
      --accent:#b91c1c; --muted:#6b7280; --bg:#f6f7f9; --card:#fff; --text:#111827;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;text-rendering:optimizeLegibility;margin:0;background:var(--bg);color:var(--text)}
    header{background:#fff;border-bottom:3px solid var(--accent);padding:.9rem 1rem;display:flex;align-items:center;justify-content:space-between;gap:12px;position:sticky;top:0;z-index:30}
    .logo{font-weight:800;color:var(--accent);text-decoration:none}
    .controls{display:flex;gap:8px;align-items:center}
    select,button,input[type="search"]{padding:.45rem .6rem;border-radius:8px;border:1px solid #e5e7eb;background:#fff}
    input[type="search"]{min-width:240px}
    main{max-width:980px;margin:18px auto;padding:0 14px 80px}
    #feed-stream{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:18px;opacity:0;transition:opacity .45s}
    main.loaded #feed-stream{opacity:1}
    .card{background:var(--card);border-radius:10px;box-shadow:0 6px 18px rgba(12,16,20,.06);overflow:hidden;border:1px solid #eaeaea;display:flex;flex-direction:column}
    .media{height:160px;background:#111;display:block;position:relative;overflow:hidden}
    .media img{width:100%;height:100%;object-fit:cover;display:block}
    .body{padding:12px;display:flex;flex-direction:column;gap:8px}
    .tag{font-size:12px;font-weight:700;color:#0f172a;opacity:.8}
    .title{font-size:1rem;font-weight:700;margin:0;line-height:1.25}
    .desc{font-size:.95rem;color:#334155;margin:0;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
    .meta{display:flex;justify-content:space-between;font-size:.85rem;color:var(--muted);padding:10px 12px;border-top:1px solid #f1f5f9}
    .loader{padding:18px;text-align:center;color:var(--muted)}
    footer{text-align:center;padding:22px;font-size:.82rem;color:var(--muted)}
    @media(max-width:520px){input[type="search"]{min-width:140px}.media{height:140px}}
  </style>
</head>
<body>
<header>
  <a class="logo" href="/">N24.in</a>
  <div class="controls" aria-hidden="false">
    <select id="time-filter" title="Select time range" aria-label="Time range">
      <option value="24h">Latest 24 hours</option>
      <option value="7d">Latest 7 days</option>
      <option value="all">All time</option>
    </select>
    <input id="q" type="search" placeholder="Search headlines..." aria-label="Search headlines" />
    <button id="clearCache" title="Clear cache">Clear Cache</button>
    <div id="status" style="padding:.45rem .7rem;border-radius:8px;background:#fff;font-weight:600;color:var(--muted)">Initializing…</div>
  </div>
</header>

<main>
  <div id="loader" class="loader">Fetching latest reports…</div>
  <div id="feed-stream" role="list"></div>
  <div id="end" class="loader" style="display:none">No more items</div>
</main>

<footer>&copy; N24.in · Aggregating public RSS for educational purposes. Publishers retain content rights.</footer>

<script>
/* --------------- CONFIG --------------- */
/* News sources: Prefer site RSS where available. If you use Google News search, exclude BBC/DW explicitly. */
const NEWS_SOURCES = [
  // If a site has an RSS feed, use it (preferred)
  {name:'The Wire (Hindi)', rss:'https://thewire.in/feeds/section/hindi'}, // example - update to actual feed if available
  {name:'Satya (Hindi) - Google', query:'site:satyahindi.com -site:bbc.com/hindi -site:dw.com/hi'},
  {name:'Newslaundry', rss:'https://www.newslaundry.com/rss'},
  {name:'The Quint (Hindi)', rss:'https://hindi.thequint.com/rss'}
];

/* Video channels by YouTube channel_id (keeps feed stable) */
const VIDEO_SOURCES = [
  {name:'Ravish Kumar', channel:'UC0yXUUIaPVAqZLgRjvtMftw'},
  {name:'Punya Prasun Bajpai', channel:'UCXCG3leC3eHChlU2OPWMk_A'}
];

/* Excluded domains (to avoid DW/BBC) when using search queries */
const EXCLUDE_DOMAINS = ['bbc.com/hindi','dw.com/hi'];

/* Proxy & caching */
const RSS2JSON = 'https://api.rss2json.com/v1/api.json?rss_url=';
const ALLORIGINS_RAW = 'https://api.allorigins.win/raw?url=';
const CACHE_TTL_MS = 5 * 60 * 1000; // 5 minutes cache

/* Rendering / paging */
let ITEMS = [];               // all parsed items
let RENDER = [];              // filtered & sorted
let DISPLAY_LIMIT = 24;
const INCREMENT = 12;

/* Utilities */
const $ = id => document.getElementById(id);
const statusEl = $('status');
const loaderEl = $('loader');
const stream = $('feed-stream');
const qInput = $('q');
const timeFilter = $('time-filter');

/* small helper - fetch with timeout */
function fetchWithTimeout(url, opts={}, timeout=10000){
  const controller = new AbortController();
  const id = setTimeout(()=>controller.abort(), timeout);
  return fetch(url, {...opts, signal: controller.signal})
    .finally(()=>clearTimeout(id));
}

/* Cache helpers */
function setCache(key,obj){ try{ localStorage.setItem(key, JSON.stringify({ts:Date.now(),v:obj})); }catch(e){} }
function getCache(key){ try{ const s=localStorage.getItem(key); if(!s) return null; const o=JSON.parse(s); if(Date.now()-o.ts>CACHE_TTL_MS) { localStorage.removeItem(key); return null } return o.v }catch(e){return null} }

/* ----------------- PARSING ----------------- */
/* parse raw XML string -> items array */
function parseXmlFeed(xmlText, sourceName, typeHint='news'){
  const parser = new DOMParser();
  const xml = parser.parseFromString(xmlText, 'application/xml');
  if(xml.querySelector('parsererror')) throw new Error('XML parse error');
  const entries = xml.querySelectorAll('item, entry');
  const out = [];
  entries.forEach(ent=>{
    const title = (ent.querySelector('title')?.textContent||'').trim();
    if(!title || title.length<6) return;
    const pub = ent.querySelector('pubDate')?.textContent || ent.querySelector('published')?.textContent || ent.querySelector('updated')?.textContent;
    const linkEl = ent.querySelector('link[rel="alternate"]') || ent.querySelector('link');
    let link = linkEl ? (linkEl.getAttribute ? linkEl.getAttribute('href') || linkEl.textContent : linkEl.textContent) : (ent.querySelector('guid')?.textContent || '');
    // Google News link formatting: contains url=...
    const urlMatch = link.match(/url=([^&]+)/);
    if(urlMatch) link = decodeURIComponent(urlMatch[1]);
    // snippet
    let snippet = ent.querySelector('description')?.textContent || ent.querySelector('summary')?.textContent || '';
    // If snippet contains HTML, strip tags quickly
    snippet = snippet.replace(/<\/?[^>]+(>|$)/g, '').trim();
    // thumbnail (media:thumbnail or enclosure or youtube)
    let thumb = ent.querySelector('media\\:thumbnail')?.getAttribute('url') || ent.querySelector('media\\:content')?.getAttribute('url') || ent.querySelector('enclosure')?.getAttribute('url') || '';
    if(!thumb && typeHint==='video'){
      // if link contains youtu.be or v= then extract id and build thumbnail
      const m = link.match(/(?:v=|youtu\.be\/|embed\/|shorts\/)([^&\n?#]+)/);
      if(m) thumb = `https://i.ytimg.com/vi/${m[1]}/mqdefault.jpg`;
    }
    const date = pub ? new Date(pub) : new Date();
    if(isNaN(date.getTime())) return;
    out.push({source:sourceName,title,link,date,type:typeHint,thumb,snippet});
  });
  return out;
}

/* ----------------- FETCHING STRATEGY ----------------- */
/* Try rss2json (JSON), else allorigins raw + parse XML */
async function tryFetchFeed(rssUrl, sourceName, typeHint='news'){
  const cacheKey = `n24_cache_${btoa(rssUrl)}`;
  const cached = getCache(cacheKey);
  if(cached) return cached;

  // 1) Try rss2json (returns JSON if good)
  try {
    const url = RSS2JSON + encodeURIComponent(rssUrl);
    const res = await fetchWithTimeout(url, {}, 10000);
    if(res.ok){
      const json = await res.json();
      if(json && Array.isArray(json.items) && json.items.length){
        const normalized = json.items.map(it=>{
          const date = it.pubDate ? new Date(it.pubDate) : (it.isoDate ? new Date(it.isoDate) : new Date());
          const link = it.link || it.guid || '';
          const thumb = it.thumbnail || it.enclosure?.link || '';
          const snippet = (it.description||'').replace(/<\/?[^>]+(>|$)/g,'').slice(0,220);
          return {source:sourceName,title:it.title,link,date,type:typeHint,thumb,snippet};
        });
        setCache(cacheKey,normalized);
        return normalized;
      }
    }
  } catch (e) {
    // ignore and fallback
    console.warn('rss2json failed for',rssUrl,e.message);
  }

  // 2) Try allorigins raw and parse XML
  try {
    const res = await fetchWithTimeout(ALLORIGINS_RAW + encodeURIComponent(rssUrl), {}, 10000);
    if(!res.ok) throw new Error('allorigins returned ' + res.status);
    const text = await res.text();
    const parsed = parseXmlFeed(text, sourceName, typeHint);
    if(parsed.length){
      setCache(cacheKey, parsed);
      return parsed;
    }
  } catch (e) {
    console.warn('allorigins/raw failed for',rssUrl,e.message);
  }

  // 3) Last-ditch: try direct fetch (may be CORS-blocked on GH pages)
  try {
    const res = await fetchWithTimeout(rssUrl, {}, 8000);
    if(res.ok){
      const text = await res.text();
      const parsed = parseXmlFeed(text, sourceName, typeHint);
      if(parsed.length){
        setCache(cacheKey, parsed);
        return parsed;
      }
    }
  } catch(e){
    console.warn('direct fetch failed for',rssUrl,e.message);
  }

  return []; // failed
}

/* Build Google News RSS search URL from query, with explicit excludes */
function googleNewsRssForQuery(q){
  const excludes = EXCLUDE_DOMAINS.map(d => `-site:${d}`).join(' ');
  const query = `${q} ${excludes}`;
  return `https://news.google.com/rss/search?q=${encodeURIComponent(query)}&hl=hi&gl=IN&ceid=IN:hi`;
}

/* Normalize configured NEWS_SOURCES to rss URLs (site rss or google search) */
function prepareNewsTasks(){
  const tasks = [];
  for(const s of NEWS_SOURCES){
    if(s.rss){
      tasks.push({url:s.rss,name:s.name,type:'news'});
    } else if(s.query){
      tasks.push({url:googleNewsRssForQuery(s.query),name:s.name,type:'news'});
    } else {
      console.warn('Unknown news source config',s);
    }
  }
  return tasks;
}

/* Video feed URL builder */
function youtubeRssForChannel(id){ return `https://www.youtube.com/feeds/videos.xml?channel_id=${id}` }

/* ----------------- HIGH LEVEL LOAD ----------------- */
async function fetchAllFeeds(){
  ITEMS = [];
  updateStatus('Fetching…');

  const newsTasks = prepareNewsTasks();
  const videoTasks = VIDEO_SOURCES.map(v=>({url:youtubeRssForChannel(v.channel),name:v.name,type:'video'}));
  const allTasks = [...newsTasks,...videoTasks];

  // cap concurrency: process batches to avoid flooding proxies
